---
title: "p8105_hw5_jak2312"
author: "Jared Klug"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
```

## Problem 1

Read and clean df
```{r}
homicide_df = 
  read_csv("./data/homicide/homicide-data.csv") %>% 
  mutate(
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest" ~ "unsolved",
      disposition == "Closed by arrest" ~ "solved"
    ),
    city_state = str_c(city, state, sep = "_")
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")
```

create aggregate df
```{r}
aggregate_df = 
  homicide_df %>% 
    group_by(city_state) %>% 
    summarize(
      hom_total = n(),
      hom_unsolved = sum(resolved == "unsolved")
    ) 
```

run prop test for 1 city
```{r}
prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved),
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)
) %>% broom::tidy()
```

itterate over all the cities
```{r}
results_df = 
  aggregate_df %>% 
    mutate(
      prop_test = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
      tidy_test = map(prop_test, broom::tidy)
    ) %>% 
    select(-prop_test) %>% 
    unnest(tidy_test) %>% 
    select(city_state, estimate, conf.low, conf.high)
```

Arrange by estimate
```{r}
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Problem 2

```{r read_combine_df}
study_data = tibble(
    filename = list.files("./data/longitudinal_study/"),
    subject_data = map(str_c("./data/longitudinal_study/", filename), read.csv)
  ) %>% 
  separate(filename, into = c("arm", "subject_id"), sep = "_") %>% 
  mutate(subject_id = str_replace(subject_id, ".csv", ""),
         subject_id = as.numeric(subject_id),
         subject_id = ifelse(str_detect(arm, "exp"), subject_id + 10, subject_id))
```

```{r tidy_df}
pat_data_long = function(df){
  df %>% pivot_longer(week_1:week_8,
                      names_to = "week",
                      names_prefix = "week_",
                      values_to = "data")
}

for(i in 1:20){
  study_data$subject_data[[i]] = pat_data_long(study_data$subject_data[[i]])
}

study_data
study_data$subject_data[[1]]
```

```{r plot_data_vs_week}

study_data %>% 
  unnest(subject_data) %>% 
  ggplot(aes(x = week, y = data, group = subject_id)) +
  geom_line(aes(color = arm))

```

We can see that subjects in both the experimental arm and control arm have points that fluctuate throughout the 8 weeks. However, we can observe a general upwards trend in the experimental arm which can indicate that the treatment these subjects are getting is influencing the data. The control arm data fluctuates heavily but there does not appear to be an overall change in the output reading. 

## Problem 3

```{r}

```



